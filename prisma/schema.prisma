datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  USER
  ADMIN
  FOUNDER
  MENTOR
}

enum VentureType {
  ECOMMERCE
  SAAS
  SERVICE
  MARKETPLACE
  AGENCY
  OTHER
}

enum VentureStatus {
  IDEATION
  IN_PROGRESS
  LAUNCHED
  PAUSED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SquadRole {
  LEAD    // Squad Lead (decision maker, founder)
  MEMBER  // Regular member
  GUEST   // Observer only (limited access)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          Role      @default(USER)
  notionId      String?   @unique

  // Relations
  squadMemberships SquadMember[]

  votes         Vote[]
  karma         Karma[]
  ventures      Venture[]
  ventureTasks  VentureTask[]
  mentoringSessions MentoringSession[]
  moderationWarnings ModerationWarning[]

  // NextAuth
  accounts      Account[]
  sessions      Session[]

  // Moderation
  toxicityWarnings Int      @default(0)
  isBanned         Boolean  @default(false)
  banReason        String?
  bannedAt         DateTime?

  // Stripe Subscription (69€/mo Platform Fee)
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique
  subscriptionStatus    String?  // active, cancelled, past_due, trialing
  subscriptionTier      String   @default("founder") // founder, pro, enterprise
  subscriptionEndsAt    DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Squad {
  id          String   @id @default(cuid())
  name        String
  description String?
  slug        String   @unique

  // Stripe Connect (Squad erhält Zahlungen)
  stripeConnectedAccountId String?  @unique
  stripeAccountStatus      String?  // pending, enabled, disabled, rejected
  stripeOnboardingComplete Boolean  @default(false)
  stripeChargesEnabled     Boolean  @default(false) // Kann Squad Zahlungen empfangen?
  stripePayoutsEnabled     Boolean  @default(false) // Kann Squad auszahlen?

  members     SquadMember[]
  roadmaps    RoadmapItem[]
  ventures    Venture[]
  transactions SquadTransaction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// SQUAD MEMBERSHIP - Many-to-Many System
// ============================================

model SquadMember {
  id          String    @id @default(cuid())

  // Relations
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  squadId     String
  squad       Squad     @relation(fields: [squadId], references: [id], onDelete: Cascade)

  // Role & Permissions
  role        SquadRole @default(MEMBER)

  // Equity & Ownership (optional for revenue sharing)
  equityShare Float?    // Percentage: 20.5 = 20.5%

  // Timestamps
  joinedAt    DateTime  @default(now())
  leftAt      DateTime? // Track when they left (soft delete)

  // Prevent duplicate memberships
  @@unique([userId, squadId])
  @@index([userId])
  @@index([squadId])
  @@index([role])
}

model RoadmapItem {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("PLANNED") // PLANNED, IN_PROGRESS, DONE
  
  squadId     String
  squad       Squad    @relation(fields: [squadId], references: [id])
  
  votes       Vote[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Vote {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  roadmapItemId String
  roadmapItem   RoadmapItem @relation(fields: [roadmapItemId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime    @default(now())

  @@unique([userId, roadmapItemId]) // Prevent duplicate votes
}

model Karma {
  id        String   @id @default(cuid())
  points    Int
  reason    String
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Optional: Link to specific actions
  squadId   String?  // Context for the karma
  
  createdAt DateTime @default(now())

  @@index([squadId]) // Performance index as requested
}

// NextAuth Models
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@id([provider, providerAccountId])
}
 
model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
 
model VerificationToken {
  identifier String
  token      String
  expires    DateTime
 
  @@id([identifier, token])
}

// ============================================
// VENTURE CREATION SYSTEM
// ============================================

model Venture {
  id              String        @id @default(cuid())
  name            String
  description     String?
  type            VentureType   @default(OTHER)
  status          VentureStatus @default(IDEATION)

  // Wizard Progress
  currentStep     Int           @default(1)
  completedSteps  Int[]         @default([])

  // Business Data
  productType     String?
  targetMarket    String?
  brandColors     String?       // JSON: ["#hex1", "#hex2"]
  logoUrl         String?
  pricing         Json?         // Flexible pricing structure
  marketingBudget Float?
  totalBudget     Float?
  estimatedRevenue Float?

  // Deadlines & Tracking
  launchDate      DateTime?
  lastActivityAt  DateTime      @default(now())

  // Relations
  ownerId         String
  owner           User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  squadId         String?
  squad           Squad?        @relation(fields: [squadId], references: [id])

  tasks           VentureTask[]
  steps           VentureStep[]
  costs           CostItem[]
  resources       VentureResource[]
  mentoringSessions MentoringSession[]
  brandDNA        BrandDNA?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([ownerId])
  @@index([squadId])
  @@index([status])
}

// ============================================
// BRAND DNA - AI Context System
// ============================================

model BrandDNA {
  id              String   @id @default(cuid())
  ventureId       String   @unique
  venture         Venture  @relation(fields: [ventureId], references: [id], onDelete: Cascade)

  // Core Identity
  brandName       String
  tagline         String?
  mission         String?   // "Why we exist"
  vision          String?   // "Where we're going"
  values          String[]  @default([]) // ["Sustainability", "Innovation"]

  // Voice & Tone (for AI content generation)
  toneOfVoice     String?   // "Professional", "Casual", "Edgy", "Friendly"
  personality     String[]  @default([]) // ["Bold", "Playful", "Authentic"]
  writingStyle    String?   // "Short & punchy", "Detailed & informative"

  // Target Audience
  targetAudience  Json?     // { age: "25-35", gender: "all", location: "EU", interests: [] }
  customerPersona String?   // Free text description

  // Visual Identity
  primaryColor    String?   // "#D4AF37"
  secondaryColors String[]  @default([]) // ["#000000", "#FFFFFF"]
  logoUrl         String?
  fontFamily      String?   // "Inter, sans-serif"

  // Product/Service
  productCategory String?   // "Fashion", "Food", "SaaS"
  keyFeatures     String[]  @default([]) // ["Organic", "Handmade", "Sustainable"]
  usp             String?   // Unique Selling Proposition

  // Competitors (for context)
  competitors     Json?     // [{ name: "Brand X", url: "...", strengths: [] }]

  // AI Context (Most Important!)
  aiContext       String?   // Free text for Gemini: "Always mention sustainability..."
  doNotMention    String[]  @default([]) // Topics to avoid in AI responses

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ventureId])
}

model VentureStep {
  id              String   @id @default(cuid())
  ventureId       String
  venture         Venture  @relation(fields: [ventureId], references: [id], onDelete: Cascade)

  stepNumber      Int
  stepName        String
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  data            Json?    // Step-specific data

  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([ventureId, stepNumber])
  @@index([ventureId])
}

model VentureTask {
  id              String       @id @default(cuid())
  title           String
  description     String?
  status          String       @default("TODO") // TODO, IN_PROGRESS, DONE, BLOCKED
  priority        TaskPriority @default(MEDIUM)

  // Deadlines
  dueDate         DateTime?
  completedAt     DateTime?
  overdueNotifiedAt DateTime?  // Track when mentor was notified

  // Relations
  ventureId       String
  venture         Venture      @relation(fields: [ventureId], references: [id], onDelete: Cascade)

  assignedToId    String?
  assignedTo      User?        @relation(fields: [assignedToId], references: [id])

  // Template Data
  isFromTemplate  Boolean      @default(false)
  templateOrder   Int?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([ventureId])
  @@index([assignedToId])
  @@index([dueDate])
  @@index([status])
}

model VentureTemplate {
  id              String   @id @default(cuid())
  name            String
  description     String?
  type            VentureType

  // Template Data
  defaultSteps    Json     // Array of step configs
  defaultTasks    Json     // Array of task templates with deadlines
  estimatedDuration Int?   // Days to complete

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
}

model CostItem {
  id              String   @id @default(cuid())
  category        String   // MARKETING, DEVELOPMENT, OPERATIONS, etc.
  name            String
  amount          Float
  isRecurring     Boolean  @default(false)
  frequency       String?  // MONTHLY, YEARLY, ONCE

  ventureId       String
  venture         Venture  @relation(fields: [ventureId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ventureId])
  @@index([category])
}

model Resource {
  id              String   @id @default(cuid())
  title           String
  description     String?
  category        String   // B2B_DIRECTORY, TEMPLATE, TOOL, GUIDE
  type            String?  // SUPPLIER, MANUFACTURER, SERVICE

  // Resource Data
  url             String?
  contactEmail    String?
  contactInfo     Json?
  tags            String[] @default([])

  // B2B Specific
  minOrderQty     Int?
  priceRange      String?
  location        String?

  isPublic        Boolean  @default(true)
  ventures        VentureResource[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([type])
}

model VentureResource {
  id              String   @id @default(cuid())
  ventureId       String
  venture         Venture  @relation(fields: [ventureId], references: [id], onDelete: Cascade)

  resourceId      String
  resource        Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  notes           String?
  createdAt       DateTime @default(now())

  @@unique([ventureId, resourceId])
  @@index([ventureId])
  @@index([resourceId])
}

model MentoringSession {
  id              String   @id @default(cuid())
  ventureId       String
  venture         Venture  @relation(fields: [ventureId], references: [id], onDelete: Cascade)

  mentorId        String
  mentor          User     @relation(fields: [mentorId], references: [id])

  reason          String   // DEADLINE_OVERDUE, REQUESTED, SCHEDULED
  notes           String?
  outcome         String?

  scheduledAt     DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ventureId])
  @@index([mentorId])
}

model ModerationWarning {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  reason          String   // AI-detected reason (toxicity, spam, harassment, etc.)
  content         String   // The content that triggered the warning
  severity        String   // LOW, MEDIUM, HIGH
  warningNumber   Int      // 1, 2, 3 (helps track which warning this is)

  acknowledged    Boolean  @default(false)
  acknowledgedAt  DateTime?

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model LinkPreview {
  id              String   @id @default(cuid())
  url             String   @unique

  // Metadata from OpenGraph/Twitter Cards
  title           String?
  description     String?
  image           String?
  siteName        String?

  // AI-generated summary
  aiSummary       String?

  // Cache control
  fetchedAt       DateTime @default(now())
  expiresAt       DateTime? // Cache expiry

  @@index([url])
  @@index([fetchedAt])
}

// ============================================
// STRIPE CONNECT - TRANSACTION LOG
// ============================================
// WICHTIG: Dies ist NUR ein Log für Transparenz!
// Wir halten KEIN Geld! Alle Gelder laufen über Stripe Connect.

enum TransactionType {
  SALE              // Squad verkauft Produkt (Shop)
  REFUND            // Rückerstattung
  PLATFORM_FEE      // Unsere Provision (automatisch von Stripe)
  PAYOUT            // Squad zahlt aus (Stripe → Squad Bank)
  SUBSCRIPTION      // User zahlt 69€/mo (geht an uns)
}

enum TransactionStatus {
  PENDING           // Zahlung wird verarbeitet
  SUCCEEDED         // Erfolgreich
  FAILED            // Fehlgeschlagen
  REFUNDED          // Rückerstattet
}

model SquadTransaction {
  id              String   @id @default(cuid())

  // Relation
  squadId         String
  squad           Squad    @relation(fields: [squadId], references: [id], onDelete: Cascade)

  // Transaction Details
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  amount          Float    // In EUR (oder currency)
  currency        String   @default("EUR")

  // Stripe IDs (für Nachverfolgung, NICHT für Geld-Holding!)
  stripePaymentIntentId    String?  @unique
  stripeChargeId           String?
  stripeTransferId         String?  // Transfer zu Squad Connected Account

  // Platform Fee (unsere Provision)
  platformFeeAmount Float?  // z.B. 5€ bei 100€ Sale
  platformFeePercent Float? // z.B. 5.0 (= 5%)

  // Description & Metadata
  description     String?
  metadata        Json?    // Flexible Daten (order_id, customer_email, etc.)

  // Related Order/Customer (optional)
  customerEmail   String?
  orderId         String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([squadId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([stripePaymentIntentId])
}
